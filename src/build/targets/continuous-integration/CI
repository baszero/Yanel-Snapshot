#!/bin/sh
if [ $# -ne 2 ]; then
	echo "Usage: CI <HTTP port> <HTTPS port>"
	exit 2
fi
set -ex
HTTP_PORT=$1
HTTPS_PORT=$2
TOMCAT_HOME=/opt/hudson/home/jobs/Yanel-trunk/workspace/yanel-trunk.working-copy/local/apache-tomcat-5.5.20 #XXX HACK: leaving that blank does not work yet

YANEL_SOURCE_HOME=`dirname $0`/../../../..
cd $YANEL_SOURCE_HOME

rm -f src/build/local.build.properties
./build.sh clean-all
#TODO: use our own Maven local repo instead of the user's!

./yanel.sh configure -Danswer=NO \
 -DanswerReconfigureTomcat1=YES \
 -DpathOfUserSpecificTomcat=$TOMCAT_HOME

BUILD_OPTS="-Dtomcat1.ssl.port=$HTTPS_PORT -Dtomcat1.http.port=$HTTP_PORT"

#TODO: delete then recreate a few resources from scratch:
#./build.sh new-resource-type ...

./build.sh $BUILD_OPTS -Danswer=YES #XXX HACK: endorsed lib management always uses the same variable to ask for user input

# Patch Tomcat ports:
tools/apache-ant/bin/ant -f tools/apache-tomcat/build.xml configure-host -Dtomcat.home.dir=$TOMCAT_HOME -Dhost=localhost -Dhost.HTTP.port=$HTTP_PORT -Dhost.HTTPS.port=$HTTPS_PORT

./yanel.sh start

cat > src/test/htmlunit/local.htmlunit-properties.xml <<EOF #FIXME: do this in a portable way
<config>
  <htmlunit>
    <debugLevel>4</debugLevel>
    <baseUrl>http://localhost:$HTTP_PORT/yanel/</baseUrl>
    <reservedPrefix>yanel/</reservedPrefix>
    <language>en</language>
  </htmlunit>
</config>
EOF
./build.sh test -Dwebtest.home.dir=/opt/canoo/webtest-3.0-R_1758 -Dwebtest.config.host=localhost -Dwebtest.config.protocol=http -Dwebtest.config.port=$HTTP_PORT -Dheadless=
#TODO: test the resources from scratch

./yanel.sh stop

./build.sh clean -Dforce-clean=true
