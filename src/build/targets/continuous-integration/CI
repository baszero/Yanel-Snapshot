#!/bin/sh

if [ $# -ne 2 ]; then
	echo "Usage: CI <HTTP port> <HTTPS port>"
	exit 2
fi
set -ex
HTTP_PORT=$1
HTTPS_PORT=$2
#TOMCAT_HOME=/home/michi/src/yanel-trunk/hudson/yanel-trunk/apache-tomcat-5.5.20 #XXX HACK: leaving that blank does not work yet
TOMCAT_HOME=/opt/hudson/home/jobs/Yanel-trunk/workspace/yanel-trunk.working-copy/local/apache-tomcat-5.5.20 #XXX HACK: leaving that blank does not work yet
#TOMCAT_HOME=/Users/michaelwechner/src/wyona/public/yanel/trunk/hudson/apache-tomcat-5.5.20 #XXX HACK: leaving that blank does not work yet
#WEBTEST_HOME_DIR=/home/michi/local/canoo-DEV_R_1721
WEBTEST_HOME_DIR=/opt/canoo/webtest-3.0-R_1758
#WEBTEST_HOME_DIR=/Users/michaelwechner/local/canoo-VERSION_r_1762

YANEL_SOURCE_HOME=`dirname $0`/../../../..
cd $YANEL_SOURCE_HOME

./build.sh clean-all -DanswerDeleteLocalBuildProperties=yes -DanswerDeleteLocalConfigDir=NO -DanswerCleanTomcatClusterNode1=yes
#TODO: use our own Maven local repo instead of the user's!

./yanel.sh configure -Danswer=NO \
 -DanswerReconfigureTomcat1=no \
 -DpathOfUserSpecificTomcat=$TOMCAT_HOME
#FIXME: we do not reconfigure Tomcat for SSL because Canoo tests fail with SSL activated! :/

#BUILD_OPTS="-Dtomcat1.ssl.port=$HTTPS_PORT -Dtomcat1.http.port=$HTTP_PORT"
BUILD_OPTS=
#FIXME: we do not configure the ports used for switching back and forth to HTTPS from HTTP because Canoo tests fail with SSL activated! :/

#TODO: delete then recreate a few resources from scratch:
#./build.sh new-resource-type ...

./build.sh $BUILD_OPTS -Danswer=YES #XXX HACK: endorsed lib management always uses the same variable to ask for user input

# Patch Tomcat ports:
tools/apache-ant/bin/ant -f tools/apache-tomcat/build.xml configure-host -Dtomcat.home.dir=$TOMCAT_HOME -Dhost=localhost -Dhost.HTTP.port=$HTTP_PORT -Dhost.HTTPS.port=$HTTPS_PORT

./yanel.sh start

cat > src/test/htmlunit/local.htmlunit-properties.xml <<EOF #FIXME: do this in a portable way
<config>
  <htmlunit>
    <debugLevel>4</debugLevel>
    <baseUrl>http://localhost:$HTTP_PORT/yanel/</baseUrl>
    <reservedPrefix>yanel/</reservedPrefix>
    <language>en</language>
  </htmlunit>
</config>
EOF

# Also see src/build/targets/test.xml
./build.sh test -Dwebtest.home.dir=$WEBTEST_HOME_DIR -Dwebtest.config.host=localhost -Dwebtest.config.protocol=http -Dwebtest.config.port=$HTTP_PORT -Dheadless=
#TODO: test the resources from scratch

./yanel.sh stop

# clean-all is already executed at the beginning of this script
#./build.sh clean -Dforce-clean=true
