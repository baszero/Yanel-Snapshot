<?xml version="1.0"?>

<project name="build-uppdate-war" default="update-war" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
  
  <target name="update-war" description="Create a war to update" depends="init, webapp">
    <delete dir="${build.dir}/update-war"/>
    <property name="update.dir" value="${build.dir}/update-war/wyona-yanel-UPDATE-${yanel.version}-r${yanel.revision}"/>
    <mkdir dir="${update.dir}"/>
    
   <copy todir="${update.dir}/${servlet.context.prefix}">
      <fileset dir="${yanel.home.dir}/build/webapps/${servlet.context.prefix}"/>
    </copy>
    <copy todir="${update.dir}/${servlet.context.prefix}/realms">
      <fileset dir="${yanel.home.dir}/src/realms"/>
    </copy>
    <replace file="${update.dir}/${servlet.context.prefix}/realms/javadoc/repository.xml" value="content">
      <replacetoken>../../../build/javadoc</replacetoken>
    </replace>
    <replace file="${update.dir}/${servlet.context.prefix}/realms/test/yanel/config/data-repository.xml" value="../data">
      <replacetoken>../../../../../local/test/data</replacetoken>
    </replace>
    <copy todir="${update.dir}/${servlet.context.prefix}/realms/javadoc/content">
      <fileset dir="${yanel.home.dir}/build/javadoc"/>
    </copy>
    <copy file="${yanel.home.dir}/conf/realms.xml" todir="${update.dir}/${servlet.context.prefix}/WEB-INF/classes" overwrite="true"/>
    <replace file="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/realms.xml" value="../../realms">
      <replacetoken>@REALMS_DIR@</replacetoken>
    </replace>
    <copy todir="${update.dir}/${servlet.context.prefix}/resources">
      <fileset dir="${yanel.home.dir}/src/resources"/>
    </copy>
    <copy todir="${update.dir}/${servlet.context.prefix}/resources">
      <fileset dir="${yanel.home.dir}/src/contributions/resources"/>
    </copy>
    <copy todir="${update.dir}/${servlet.context.prefix}/resources">
      <fileset dir="${yanel.home.dir}/src/realms/welcome-admin/yanel/resources"/>
    </copy>
    <xslt in="${yanel.home.dir}/conf/yanel.xml" out="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/yanel.properties" style="yanel2properties.xsl" force="true">
      <!--<param name="servlet.context.prefix" expression="${servlet.context.prefix}"/>-->
    </xslt>
    <replace file="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/yanel.properties" value="../../resources">
      <replacetoken>../src/resources</replacetoken>
    </replace>
    <replace file="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/yanel.properties" value="../../resources">
      <replacetoken>../src/contributions/resources</replacetoken>
    </replace>
    <replace file="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/yanel.properties" value="../../resources">
      <replacetoken>../src/realms/welcome-admin/yanel/resources</replacetoken>
    </replace>
    <copy file="${yanel.home.dir}/src/binary-dist/log4j.properties" todir="${update.dir}/${servlet.context.prefix}/WEB-INF/classes" overwrite="true"/>
    <replace file="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/log4j.properties" value="${servlet.context.prefix}">
      <replacetoken>@SERVLET_CONTEXT@</replacetoken>
    </replace> 
    <mkdir dir="${update.dir}/${servlet.context.prefix}/WEB-INF/logs"/>

    <copy file="${yanel.home.dir}/src/build/install.rdf" todir="${update.dir}/${servlet.context.prefix}/WEB-INF/classes" overwrite="true"/>
    <replace file="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/install.rdf" value="${yanel.version}-r${yanel.revision}">
      <replacetoken>@VERSION@</replacetoken>
    </replace>
    <replace file="${update.dir}/${servlet.context.prefix}/WEB-INF/classes/install.rdf" value="update">
      <replacetoken>@INSTALLTYPE@</replacetoken>
    </replace>
    
    <jar jarfile="${build.dir}/update-war/wyona-yanel-webapp-v-${yanel.version}-r-${yanel.revision}.war" basedir="${update.dir}/${servlet.context.prefix}"/>
    
    <delete dir="${update.dir}"/>
  </target>  
</project>
