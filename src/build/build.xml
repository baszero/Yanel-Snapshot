<?xml version="1.0"?>

<project name="yanel" default="deploy">
<!--
<project name="yanel" default="war">
-->

  <target name="init" description="Initialize all parameters and other settings">
    <property file="local.build.properties"/>
    <property file="build.properties"/>

    <dirname property="build.src.dir" file="${ant.file}"/>
    <dirname property="src.dir" file="${build.src.dir}"/>
    <dirname property="yanel.home.dir" file="${src.dir}"/>

    <property name="build.dir" value="${yanel.home.dir}/build"/>
    <property name="classes.dir" value="${build.dir}/classes"/>

    <path id="classpath">
      <fileset dir="${yanel.home.dir}/lib">
        <include name="*.jar"/>
      </fileset>
    </path>

    <path id="classpath.yanel">
      <fileset dir="${yanel.home.dir}/build/lib">
        <include name="*.jar"/>
      </fileset>
    </path>

    <path id="classpath.resources">
      <fileset dir="${yanel.home.dir}/src/resources/tape/build/lib">
        <include name="*.jar"/>
      </fileset>
      <fileset dir="${yanel.home.dir}/src/resources/invoice/build/lib">
        <include name="*.jar"/>
      </fileset>
      <fileset dir="${yanel.home.dir}/src/resources/websearch/build/lib">
        <include name="*.jar"/>
      </fileset>
    </path>
  </target>

  <target name="compile-core" description="Compile Java classes of Yanel core" depends="init">
<!--
    <echo>${classes.dir}</echo>
-->
    <mkdir dir="${classes.dir}"/>
    <javac srcdir="${yanel.home.dir}/src/java/org/wyona/yanel/core" destdir="${classes.dir}"
      debug="true"
    />
    <mkdir dir="${yanel.home.dir}/build/lib"/>
    <jar destfile="${yanel.home.dir}/build/lib/yanel-core-0.0.1-dev-r${yanel.revision}.jar"
      basedir="${classes.dir}"
      includes="org/wyona/yanel/core/**"/>
  </target>

  <target name="compile-impl" description="Compile Java classes of Yanel implementation" depends="init">
    <mkdir dir="${classes.dir}"/>
    <javac srcdir="${yanel.home.dir}/src/java/org/wyona/yanel/impl" destdir="${classes.dir}"
      debug="true"
    />
    <mkdir dir="${yanel.home.dir}/build/lib"/>
    <jar destfile="${yanel.home.dir}/build/lib/yanel-impl-0.0.1-dev-r${yanel.revision}.jar"
      basedir="${classes.dir}"
      includes="org/wyona/yanel/impl/**"/>
  </target>

  <target name="compile-tape-resource" description="Compile Java classes of Tape resource" depends="init">
    <property name="tape-resource.classes.dir" value="${yanel.home.dir}/src/resources/tape/build/classes"/>
    <mkdir dir="${tape-resource.classes.dir}"/>
    <javac srcdir="${yanel.home.dir}/src/resources/tape/src/java" destdir="${tape-resource.classes.dir}"
      classpathref="classpath.yanel"
      debug="true"
    />
    <mkdir dir="${yanel.home.dir}/src/resources/tape/build/lib"/>
    <jar destfile="${yanel.home.dir}/src/resources/tape/build/lib/yanel-resource-tape-0.0.1-dev-r${yanel.revision}.jar"
      basedir="${tape-resource.classes.dir}"
    />
  </target>
  <target name="compile-invoice-resource" description="Compile Java classes of Invoice resource" depends="init">
    <property name="invoice-resource.classes.dir" value="${yanel.home.dir}/src/resources/invoice/build/classes"/>
    <mkdir dir="${invoice-resource.classes.dir}"/>
    <javac srcdir="${yanel.home.dir}/src/resources/invoice/src/java" destdir="${invoice-resource.classes.dir}"
      classpathref="classpath.yanel"
      debug="true"
    />
    <mkdir dir="${yanel.home.dir}/src/resources/invoice/build/lib"/>
    <jar destfile="${yanel.home.dir}/src/resources/invoice/build/lib/yanel-resource-invoice-0.0.1-dev-r${yanel.revision}.jar"
      basedir="${invoice-resource.classes.dir}"
    />
  </target>
  <target name="compile-websearch-resource" description="Compile Java classes of WebSearch resource" depends="init">
    <property name="websearch-resource.classes.dir" value="${yanel.home.dir}/src/resources/websearch/build/classes"/>
    <mkdir dir="${websearch-resource.classes.dir}"/>
    <javac srcdir="${yanel.home.dir}/src/resources/websearch/src/java" destdir="${websearch-resource.classes.dir}"
      classpathref="classpath.yanel"
      debug="true"
    />
    <mkdir dir="${yanel.home.dir}/src/resources/websearch/build/lib"/>
    <jar destfile="${yanel.home.dir}/src/resources/websearch/build/lib/yanel-resource-websearch-0.0.1-dev-r${yanel.revision}.jar"
      basedir="${websearch-resource.classes.dir}"
    />
  </target>

  <target name="compile-cmdl" description="Compile Java classes of Yanel command line" depends="init">
    <mkdir dir="${classes.dir}"/>
    <!-- TODO: Make util classes available also for webapp, etc. -->
    <javac srcdir="${yanel.home.dir}/src/java/org/wyona/yanel/util" destdir="${classes.dir}"
      debug="true"
    />
    <javac srcdir="${yanel.home.dir}/src/java/org/wyona/yanel/cmdl" destdir="${classes.dir}"
      debug="true"
      classpathref="classpath.resources"
    />
    <mkdir dir="${yanel.home.dir}/build/lib"/>
    <jar destfile="${yanel.home.dir}/build/lib/yanel-cmdl-0.0.1-dev-r${yanel.revision}.jar"
      basedir="${classes.dir}"
      includes="org/wyona/yanel/cmdl/**,org/wyona/yanel/util/**"/>
  </target>

  <target name="compile-webapp" description="Compile Java classes of Yanel webapp" depends="init, compile-core">
    <mkdir dir="${classes.dir}"/>
    <javac srcdir="${yanel.home.dir}/src/java/org/wyona/yanel/servlet" destdir="${classes.dir}"
      debug="true"
      classpathref="classpath"
    />
    <mkdir dir="${yanel.home.dir}/build/lib"/>
    <jar destfile="${yanel.home.dir}/build/lib/yanel-webapp-0.0.1-dev-r${yanel.revision}.jar"
      basedir="${classes.dir}"
      includes="org/wyona/yanel/servlet/**"/>
  </target>

  <target name="webapp" description="Build webapp" depends="init, compile-webapp, compile-websearch-resource, compile-invoice-resource, compile-tape-resource, compile-cmdl, compile-impl">
<!--
  <target name="webapp" description="Build webapp" depends="init, compile-webapp">
-->
    <mkdir dir="${build.dir}/webapps/yanel"/>
    <copy todir="${build.dir}/webapps/yanel">
      <fileset dir="${yanel.home.dir}/src/webapp"/>
    </copy>

    <copy todir="${build.dir}/webapps/yanel/WEB-INF/lib">
      <fileset dir="${yanel.home.dir}/build/lib"/>
    </copy>
<!--
    <copy todir="${build.dir}/webapps/yanel/WEB-INF/classes">
      <fileset dir="${yanel.home.dir}/build/classes"/>
    </copy>
-->
  </target>

  <target name="war" description="Build war file" depends="init, webapp">
    <jar jarfile="${yanel.home.dir}/build/webapps/yanel.war" basedir="${yanel.home.dir}/build/webapps/yanel"/>
  </target>

  <target name="deploy" description="Deploy war file" depends="init, war">
    <condition property="deploy-to-tomcat-cluster-node1">
      <isset property="tomcat1.webapps.dir"/>
    </condition>
    <antcall target="deploy-to-tomcat-cluster-node1"/>

    <condition property="deploy-to-tomcat-cluster-node2">
      <isset property="tomcat2.webapps.dir"/>
    </condition>
    <antcall target="deploy-to-tomcat-cluster-node2"/>
  </target>

  <target name="deploy-to-tomcat-cluster-node1" if="deploy-to-tomcat-cluster-node1" description="Deploy webapp to Tomcat cluster node 1">
    <echo>Copy webapp (${tomcat1.webapps.dir}):</echo>

    <fail message="No such directory: ${tomcat1.webapps.dir}">
    <condition><not><available file="${tomcat1.webapps.dir}"/></not></condition>
    </fail>

    <copy todir="${tomcat1.webapps.dir}/yanel">
      <fileset dir="${yanel.home.dir}/build/webapps/yanel"/>
    </copy>
  </target>

  <target name="deploy-to-tomcat-cluster-node2" if="deploy-to-tomcat-cluster-node2" description="Deploy webapp to Tomcat cluster node 2">
    <echo>Copy webapp (${tomcat2.webapps.dir}):</echo>

    <fail message="No such directory: ${tomcat2.webapps.dir}">
    <condition><not><available file="${tomcat2.webapps.dir}"/></not></condition>
    </fail>

    <copy todir="${tomcat2.webapps.dir}/yanel">
      <fileset dir="${yanel.home.dir}/build/webapps/yanel"/>
    </copy>
  </target>

  <target name="clean" description="Clean build" depends="init">
    <delete dir="${build.dir}"/>
    <delete dir="${yanel.home.dir}/src/resources/invoice/build"/>
    <delete dir="${yanel.home.dir}/src/resources/websearch/build"/>
    <delete dir="${yanel.home.dir}/src/resources/tape/build"/>
    <delete dir="${yanel.home.dir}/src/resources/calendar/build"/>
  </target>
</project>
